# Monitor Lambda - Daily validation (files + size check)
# Parameterized for environment: UAT or PROD
# Trigger only on monitor branch

trigger:
  branches:
    include:
      - monitor

pool:
  vmImage: ubuntu-latest

parameters:
  - name: environment
    type: string
    default: 'uat'
    values:
      - uat
      - prod

# Variables
variables:
  - name: monitorImageName
    value: 'aa-monitorlambda'
  - name: repositoryName
    value: ${{ format('{0}-ecr', parameters.environment) }}

# Dynamically link AWS variable group based on environment
# Azure DevOps does not support dynamic variable group selection, so we use condition
# We'll define two groups and use conditional steps to set AWS credentials
# The Docker run step will pick $(AWS_ACCESS_KEY_ID) / $(AWS_SECRET_ACCESS_KEY)

steps:

# 1Ô∏è‚É£ Install Docker
- task: DockerInstaller@0
  displayName: 'Install Docker'

# 2Ô∏è‚É£ Build Docker Image
- task: Docker@2
  displayName: 'Monitor Lambda - Build Docker Image'
  inputs:
    command: build
    repository: $(monitorImageName)
    Dockerfile: 'modules/lambda/MonitorLambda/Dockerfile'
    buildContext: 'modules/lambda/MonitorLambda'
    tags: |
      $(Build.BuildId)
    arguments: |
      --build-arg S3_BUCKET=aabackstop-${{parameters.environment}}

# 3Ô∏è‚É£ Push Docker Image to ECR
- task: ECRPushImage@1
  displayName: 'Monitor Lambda - Push image to ECR'
  inputs:
    awsCredentials: ${{ format('AWS-ECR-{0}', parameters.environment) }}
    regionName: 'eu-west-1'
    imageSource: 'imagename'
    sourceImageName: $(monitorImageName)
    sourceImageTag: $(Build.BuildId)
    repositoryName: $(repositoryName)
    pushTag: |
      monitorlambda

# 4Ô∏è‚É£ Set AWS credentials based on environment
- ${{ if eq(parameters.environment, 'uat') }}:
  - group: uat-aws-credentials
- ${{ if eq(parameters.environment, 'prod') }}:
  - group: prod-aws-credentials

# 5Ô∏è‚É£ Run Lambda Container for Daily Validation
- script: |
    echo "üöÄ Running Monitor Lambda for daily validation for environment: ${{ parameters.environment }}"

    docker run --rm \
      -e AWS_ACCESS_KEY_ID=$(AWS_ACCESS_KEY_ID) \
      -e AWS_SECRET_ACCESS_KEY=$(AWS_SECRET_ACCESS_KEY) \
      -e AWS_REGION='eu-west-1' \
      -e SECRET_NAME='azneprod' \
      -e AZURE_CONTAINER_UAT='uat' \
      -e AZURE_CONTAINER_PROD='prod' \
      -e S3_UAT_BUCKET='aabackstop-uat' \
      -e S3_PROD_BUCKET='aabackstop-prod' \
      -e MODE='daily' \
      $(monitorImageName):$(Build.BuildId)
  displayName: 'Run Monitor Lambda - Validate files & size'
