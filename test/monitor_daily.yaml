trigger:
  branches:
    include:
      - monitor

# schedule:
# - cron: "0 7 * * *"  # Daily 7 AM UTC (commented for now)

pool:
  vmImage: ubuntu-latest

parameters:
  - name: environment
    type: string
    default: 'uat'
    values:
      - uat
      - prod

name: '$(Date:yyyyMMdd)$(Rev:.r) Monitor Daily - ${{ parameters.environment }}'

variables:
  SECRET_NAME: "azneprod"
  AWS_REGION: "eu-west-1"
  MODE: "daily"
  EMAIL_TO: "venkata.kasaru@theaa.com"

steps:
- task: DockerInstaller@0
  displayName: 'Install Docker'

- task: Docker@2
  displayName: 'Monitor Lambda - Build Docker Image'
  inputs:
    command: build
    repository: 'aa-monitorlambda'
    Dockerfile: 'modules/lambda/MonitorLambda/Dockerfile'
    buildContext: 'modules/lambda/MonitorLambda'
    tags: |
      $(Build.BuildId)
    arguments: |
      --build-arg ENV=${{ parameters.environment }}

- task: ECRPushImage@1
  displayName: 'Monitor Lambda - Push image to ECR'
  inputs:
    awsCredentials: ${{ format('AWS-ECR-{0}', parameters.environment) }}
    regionName: 'eu-west-1'
    imageSource: 'imagename'
    sourceImageName: 'aa-monitorlambda'
    sourceImageTag: '$(Build.BuildId)'
    repositoryName: ${{ format('{0}-ecr', parameters.environment) }}
    pushTag: 'monitorlambda'

# ==============================
# Run the Monitor Lambda Python script using the same AWS credentials
# ==============================
- script: |
    # Use AWS credentials from the ECR task via environment variables
    export ENV=${{ parameters.environment }}
    export MODE=daily
    export AWS_DEFAULT_REGION=$(AWS_REGION)
    export AWS_ACCESS_KEY_ID=$(AWS_ACCESS_KEY_ID)
    export AWS_SECRET_ACCESS_KEY=$(AWS_SECRET_ACCESS_KEY)
    export AWS_SESSION_TOKEN=$(AWS_SESSION_TOKEN)

    pip install --upgrade pip
    pip install -r modules/lambda/MonitorLambda/requirements.txt

    python modules/lambda/MonitorLambda/monitor_lambda.py
  displayName: "Run Daily Monitor Lambda"

- task: SendEmail@1
  condition: failed()
  inputs:
    To: "$(EMAIL_TO)"
    Subject: "‚ùå Daily File Validation Failed - ${{ parameters.environment }}"
    Body: |
      Daily File Transfer Validation Report for environment: ${{ parameters.environment }}.
      Check the pipeline logs for detailed missing or zero-size file list.
