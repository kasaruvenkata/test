# Monitor Lambda - Daily validation check
# Trigger only on monitor branch

trigger:
  branches:
    include:
      - monitor

# schedule:
# - cron: "0 7 * * *"   # Daily 7 AM UTC (example)
#   displayName: Daily Monitor
#   branches:
#     include:
#       - monitor
#   always: true

pool:
  vmImage: ubuntu-latest

variables:
  - name: monitorImageName
    value: 'aa-monitorlambda'
  - name: repositoryName
    value: ${{ format('{0}-ecr', parameters.environment) }}

parameters:
  - name: environment
    type: string
    default: 'uat'
    values:
     - uat
     - prod

name: '$(Date:yyyyMMdd)$(Rev:.r) $(Build.DefinitionName) - Daily Monitoring ${{ parameters.environment }}'

steps:
- task: DockerInstaller@0
  displayName: 'Install Docker'

- task: Docker@2
  displayName: 'Monitor Lambda - Build Docker Image'
  inputs:
    command: build
    repository: $(monitorImageName)
    Dockerfile: '**/modules/lambda/MonitorLambda/Dockerfile'
    tags: |
      $(Build.BuildId)
    arguments: |
      --build-arg S3_BUCKET=aabackstop-${{parameters.environment}}
  
- task: ECRPushImage@1
  displayName: 'Monitor Lambda - Push image to ECR'
  inputs:
    awsCredentials: ${{ format('AWS-ECR-{0}', parameters.environment) }}
    regionName: 'eu-west-1'
    imageSource: 'imagename'
    sourceImageName: $(monitorImageName)
    sourceImageTag: $(Build.BuildId)
    repositoryName: $(repositoryName)
    pushTag: |
      monitorlambda
