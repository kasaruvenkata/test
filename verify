import boto3
import json

s3_client = boto3.client("s3")

def lambda_handler(event, context):
    bucket = event.get("bucket")
    transferred_files = event.get("transferred_files", [])

    print(f"üîç Verifying last transfer for bucket: {bucket}")
    if not transferred_files:
        print("‚ö†Ô∏è No transferred files provided in event.")
        return

    missing = []
    size_mismatch = []

    for file in transferred_files:
        key = file["name"]
        expected_size = file.get("size", 0)
        try:
            resp = s3_client.head_object(Bucket=bucket, Key=key)
            actual_size = resp["ContentLength"]

            if expected_size and actual_size != expected_size:
                size_mismatch.append({"file": key, "expected": expected_size, "actual": actual_size})

        except s3_client.exceptions.ClientError:
            missing.append(key)

    if missing:
        print(f"‚ùå Missing files ({len(missing)}): {missing}")
    if size_mismatch:
        print(f"‚ö†Ô∏è Size mismatch files ({len(size_mismatch)}): {size_mismatch}")
    if not missing and not size_mismatch:
        print("‚úÖ All transferred files verified successfully!")

    return {
        "bucket": bucket,
        "missing_files": missing,
        "size_mismatch": size_mismatch,
        "checked_files": len(transferred_files)
    }
